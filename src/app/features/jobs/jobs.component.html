<div class="jobs-container">
  <div class="jobs-header">
    <h1>🔄 Monitor de Jobs Asíncronos</h1>
    <p class="subtitle">
      Monitoreo en tiempo real de trabajos de generación de calendarios (con demo de 40 segundos)
    </p>

    <div class="header-actions">
      <button
        class="btn btn-primary"
        (click)="toggleCreateForm()"
        [disabled]="isLoading">
        <span *ngIf="!showCreateForm">➕ Crear Nuevo Job</span>
        <span *ngIf="showCreateForm">❌ Cancelar</span>
      </button>

      <button
        class="btn btn-secondary"
        (click)="refreshJobs()"
        [disabled]="isLoading">
        🔄 Refresh Manual
      </button>
    </div>
  </div>

  <!-- Formulario para crear nuevo job -->
  <div *ngIf="showCreateForm" class="create-form">
    <h3>🚀 Crear Nuevo Job Asíncrono</h3>
    <div class="form-row">
      <div class="form-group">
        <label for="excel">📊 Archivo Excel:</label>
        <select
          id="excel"
          [(ngModel)]="newJob.excel"
          class="form-control">
          <option *ngFor="let option of excelOptions" [value]="option">
            {{option}}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label for="properties">⚙️ Archivo Properties:</label>
        <select
          id="properties"
          [(ngModel)]="newJob.properties"
          class="form-control">
          <option *ngFor="let option of propertiesOptions" [value]="option">
            {{option}}
          </option>
        </select>
      </div>

      <div class="form-actions">
        <button
          class="btn btn-success"
          (click)="createAsyncJob()"
          [disabled]="isLoading">
          <span *ngIf="!isLoading">🚀 Crear Job (40s demo)</span>
          <span *ngIf="isLoading">⏳ Creando...</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Mensajes de error -->
  <div *ngIf="error" class="error-message">
    ❌ {{error}}
  </div>

  <!-- Loading indicator -->
  <div *ngIf="isLoading && jobs.length === 0" class="loading">
    ⏳ Cargando jobs...
  </div>

  <!-- Lista de jobs -->
  <div class="jobs-list">
    <div class="list-header">
      <h2>📋 Lista de Jobs (Auto-refresh cada 3s)</h2>
      <div class="stats">
        Total: {{jobs.length}} jobs
        <span *ngIf="jobs.length > 0">
          |
          Activos: {{getActiveJobsCount()}}
          |
          Completados: {{getCompletedJobsCount()}}
        </span>
      </div>
    </div>

    <!-- Job cards -->
    <div class="job-card" *ngFor="let job of jobs; trackBy: trackByJobId">
      <div class="job-header">
        <div class="job-status" [style.color]="getStatusColor(job.status)">
          <span class="status-icon">{{getStatusIcon(job.status)}}</span>
          <span class="status-text">{{job.status}}</span>
        </div>

        <div class="job-id">
          <strong>ID:</strong> {{job.id}}
        </div>

        <div class="job-actions">
          <button
            *ngIf="canCancel(job)"
            class="btn btn-danger btn-sm"
            (click)="cancelJob(job.id)">
            🛑 Cancelar
          </button>
        </div>
      </div>

      <div class="job-details">
        <div class="detail-row">
          <div class="detail-item">
            <strong>📅 Creado:</strong> {{formatDate(job.createdAt)}}
          </div>
          <div class="detail-item" *ngIf="job.startedAt">
            <strong>▶️ Iniciado:</strong> {{formatDate(job.startedAt)}}
          </div>
          <div class="detail-item" *ngIf="job.completedAt">
            <strong>✅ Completado:</strong> {{formatDate(job.completedAt)}}
          </div>
        </div>

        <div class="detail-row" *ngIf="job.startedAt">
          <div class="detail-item">
            <strong>⏱️ Duración:</strong> {{calculateDuration(job.startedAt, job.completedAt)}}
          </div>
          <div class="detail-item" *ngIf="job.progress !== undefined">
            <strong>📊 Progreso:</strong> {{job.progress}}%
          </div>
        </div>

        <!-- Error message -->
        <div *ngIf="job.status === 'ERROR' && job.errorMessage" class="error-details">
          <strong>💥 Error:</strong> {{job.errorMessage}}
        </div>

        <!-- Archivos de resultado -->
        <div *ngIf="hasDownloadableFiles(job)" class="result-files">
          <strong>📁 Archivos de resultado:</strong>
          <div class="file-list">
            <button
              *ngFor="let file of job.resultFiles"
              class="btn btn-link btn-sm file-download"
              (click)="downloadFile(job.id, file)">
              📥 {{file}}
            </button>
          </div>
        </div>

        <!-- Progress bar para jobs en ejecución -->
        <div *ngIf="job.status === 'RUNNING'" class="progress-section">
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="job.progress || 0"></div>
          </div>
          <div class="progress-text">
            {{job.progress || 0}}% - Procesando... (demo de 40 segundos)
          </div>
        </div>

        <!-- Indicador de pending -->
        <div *ngIf="job.status === 'PENDING'" class="pending-indicator">
          ⏳ Esperando en cola...
        </div>
      </div>
    </div>

    <!-- Empty state -->
    <div *ngIf="jobs.length === 0 && !isLoading" class="empty-state">
      <div class="empty-icon">📭</div>
      <h3>No hay jobs</h3>
      <p>Crea tu primer job asíncrono usando el botón "Crear Nuevo Job"</p>
    </div>
  </div>

  <!-- Footer info -->
  <div class="footer-info">
    <div class="info-card">
      <h4>ℹ️ Información del Demo</h4>
      <ul>
        <li>🕐 Cada job toma <strong>40 segundos</strong> para completarse (demo)</li>
        <li>🔄 Los jobs se actualizan automáticamente cada <strong>3 segundos</strong></li>
        <li>⏳ Estados: PENDING → RUNNING → COMPLETED/ERROR/CANCELLED</li>
        <li>📥 Los archivos se pueden descargar cuando el job está COMPLETED</li>
        <li>🛑 Los jobs se pueden cancelar mientras están PENDING o RUNNING</li>
      </ul>
    </div>
  </div>
</div>
